rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }
    
    // Helper function to check if user is blocked
    function isBlocked() {
      return exists(/databases/$(database)/documents/blockedUsers/$(request.auth.uid));
    }
    
    // Validate bike path data
    function validateBikePath(data) {
      return data.segments.size() >= 2
          && data.segments.size() <= 30
          && data.status in ["optimal", "medium", "sufficient", "requiresMaintenance"]
          && data.visibility in ["private", "published", "flagged"];
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;
      // Admins can read any profile
      allow read: if isAdmin();
      // Users can create/update their own profile
      allow create, update: if request.auth != null && request.auth.uid == userId;
      // Only admins can set role to admin
      allow update: if isAdmin() && request.resource.data.role == "admin";
    }
    
    // Bike paths collection
    match /bike_paths/{pathId} {
      // Public read: anyone can read published, non-deleted paths
      allow read: if resource.data.visibility == "published" 
                  && resource.data.deleted == false;
      
      // Owner read: owner can always read their own paths
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Admin read: admins can read all paths
      allow read: if isAdmin();
      
      // Create: authenticated, non-blocked users can create their own paths
      allow create: if request.auth != null
                   && !isBlocked()
                   && request.auth.uid == request.resource.data.userId
                   && validateBikePath(request.resource.data);
      
      // Owner update: owners can update their own paths
      allow update: if request.auth != null 
                   && request.auth.uid == resource.data.userId
                   && validateBikePath(request.resource.data)
                   // Prevent changing userId
                   && request.resource.data.userId == resource.data.userId;
      
      // Admin update: admins can update any path (for flagging)
      allow update: if isAdmin();
      
      // Delete: only admins can hard delete
      allow delete: if isAdmin();
    }
    
    // Path quality reports collection
    match /path_quality_reports/{reportId} {
      // Public read for published reports
      allow read: if resource.data.publishable == true;
      // Owner can read their own
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can read all
      allow read: if isAdmin();
      
      // Create: authenticated, non-blocked users only
      allow create: if request.auth != null 
                   && !isBlocked()
                   && request.auth.uid == request.resource.data.userId;
      
      // Update/Delete: owner or admin
      allow update, delete: if request.auth != null 
                           && (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // Obstacles collection
    match /obstacles/{obstacleId} {
      // Public read for published obstacles
      allow read: if resource.data.publishable == true;
      // Owner can read their own
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can read all
      allow read: if isAdmin();
      
      // Create: authenticated, non-blocked users only
      allow create: if request.auth != null 
                   && !isBlocked()
                   && request.auth.uid == request.resource.data.userId;
      
      // Update/Delete: owner or admin
      allow update, delete: if request.auth != null 
                           && (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // Trips collection
    match /trips/{tripId} {
      // Owner can read/write their own trips
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      // Create: authenticated, non-blocked users only
      allow create: if request.auth != null 
                   && !isBlocked()
                   && request.auth.uid == request.resource.data.userId;
    }
    
    // ============ MERGED VIEWS (Client-side merge for Spark plan) ============
    
    // Path Groups - Aggregated/merged view of contributions
    // On Spark plan: authenticated users can write (merge happens client-side)
    // On Blaze plan: use Cloud Functions for server-side merge
    match /pathGroups/{groupId} {
      // Public read: anyone can read merged path data
      allow read: if true;
      // Authenticated users can write (for client-side merge)
      allow write: if request.auth != null;
    }
    
    // Obstacle clusters within path groups
    match /pathGroups/{groupId}/obstacleClusters/{clusterId} {
      // Public read
      allow read: if true;
      // Authenticated users can write
      allow write: if request.auth != null;
    }
    
    // Routes cache - cached route search results
    match /routesCache/{cacheKey} {
      // Public read: anyone can read cached routes
      allow read: if true;
      // Server-only write
      allow write: if false;
    }
    
    // Path contributions (enhanced version of bike_paths for multi-user merge)
    match /pathContributions/{contributionId} {
      // Public read: anyone can read published, non-deleted contributions
      allow read: if resource.data.visibility == "published" 
                  && resource.data.get('deleted', false) == false;
      
      // Owner can read their own
      allow read: if request.auth != null && request.auth.uid == resource.data.ownerUid;
      
      // Admin can read all
      allow read: if isAdmin();
      
      // Create: authenticated, non-blocked users
      allow create: if request.auth != null 
                   && !isBlocked()
                   && request.auth.uid == request.resource.data.ownerUid;
      
      // Update: owner or admin
      allow update: if request.auth != null 
                   && (request.auth.uid == resource.data.ownerUid || isAdmin())
                   && request.resource.data.ownerUid == resource.data.ownerUid;
      
      // Delete: admin only
      allow delete: if isAdmin();
    }
    
    // ============ ADMIN MODERATION ============
    
    // Blocked users collection - admin only
    match /blockedUsers/{userId} {
      // Only admins can read blocked users list
      allow read: if isAdmin();
      // Only admins can block/unblock users
      allow write: if isAdmin();
    }
    
    // Audit logs collection - admin only
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      // Only admins can write audit logs (via admin service)
      allow create: if isAdmin();
      // Audit logs cannot be updated or deleted
      allow update, delete: if false;
    }
  }
}
